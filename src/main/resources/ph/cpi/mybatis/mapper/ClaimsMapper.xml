<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
<mapper namespace="ph.cpi.mybatis.mapper.ClaimsMapper">
	<resultMap type="ph.cpi.rest.api.model.claims.ClaimHistory" id="claimHistoryMap">
		<result property="claimId"		column="CLAIM_ID"/>
		<result property="projId"		column="PROJ_ID"/>
		<result property="histNo"		column="HIST_NO"/>
		<result property="histCategory"	column="HIST_CATEGORY"/>
		<result property="histType"		column="HIST_TYPE"/>
		<result property="exGratia"		column="EX_GRATIA"/>
		<result property="currencyCd"	column="CURRENCY_CD"/>
		<result property="currencyRt"	column="CURRENCY_RT"/>
		<result property="reserveAmt"	column="RESERVE_AMT"/>
		<result property="paytAmt"		column="PAYT_AMT"/>
		<result property="refNo"		column="REF_NO"/>
		<result property="refDate"		column="REF_DATE" typeHandler="ph.cpi.rest.api.typehandler.DateTimeTypeHandler"/>
		<result property="remarks"		column="REMARKS"/>
		<result property="createUser"	column="CREATE_USER"/>
		<result property="createDate"	column="CREATE_DATE" typeHandler="ph.cpi.rest.api.typehandler.DateTimeTypeHandler"/>
		<result property="updateUser"	column="UPDATE_USER"/>
		<result property="updateDate"	column="UPDATE_DATE" typeHandler="ph.cpi.rest.api.typehandler.DateTimeTypeHandler"/>
	</resultMap>
	
	<select id="retrieveClaimHistory" resultMap="claimHistoryMap" parameterType="java.util.Map">
		SELECT * FROM TABLE(CLM_RES_HIST_PKG.ret_clm_res_hist(
					#{claimId,jdbcType=INTEGER},
					#{projId,jdbcType=INTEGER},
					#{histNo,jdbcType=INTEGER}, 
					'', '', '',''))
	</select>
	
	<update id="saveClaimHistory" parameterType="java.util.Map">
		BEGIN
    		<foreach collection="saveClaimHistory" item="ch">
    			CLM_RES_HIST_PKG.save_clm_res_hist(
    				#{ch.claimId,jdbcType=VARCHAR},
					#{ch.projId,jdbcType=VARCHAR},
					#{ch.histNo,jdbcType=VARCHAR},
					#{ch.histCategory,jdbcType=VARCHAR},
					#{ch.histType,jdbcType=VARCHAR},
					#{ch.exGratia,jdbcType=VARCHAR},
					#{ch.currencyCd,jdbcType=VARCHAR},
					#{ch.currencyRt,jdbcType=VARCHAR},
					#{ch.reserveAmt,jdbcType=VARCHAR},
					#{ch.paytAmt,jdbcType=VARCHAR},
					#{ch.refNo,jdbcType=VARCHAR},
					CAST(to_timestamp(#{ch.refDate}, 'YYYY-MM-DD"T"HH24:MI:SS') AS DATE),
					#{ch.remarks,jdbcType=VARCHAR},
					#{ch.createUser,jdbcType=VARCHAR},
				    CAST(to_timestamp(#{ch.createDate}, 'YYYY-MM-DD"T"HH24:MI:SS') AS DATE),
				    #{ch.updateUser,jdbcType=VARCHAR},
				    CAST(to_timestamp(#{ch.updateDate}, 'YYYY-MM-DD"T"HH24:MI:SS') AS DATE)
    			);
    		</foreach>
    	END;
	</update>
	
	<resultMap type="ph.cpi.rest.api.model.claims.Claims" id="claimsListingMap">
		<result property="claimId"     		column="CLAIM_ID" />
		<result property="claimNo"     		column="CLAIM_NO" />
		<result property="cedingId"     	column="CEDING_ID" />
		<result property="cedingName"     	column="CEDING_NAME" />
		<result property="clmStatCd"     	column="CLM_STAT_CD" />
		<result property="clmStatus"     	column="CLM_STATUS" />
		<result property="policyNo"     	column="POLICY_NO" />
		<result property="insuredDesc"     	column="INSURED_DESC" />
		<result property="riskId"     		column="RISK_ID" />
		<result property="riskName"     	column="RISK_NAME" />
		<result property="lossDate"     	column="LOSS_DATE" typeHandler="ph.cpi.rest.api.typehandler.DateTimeTypeHandler" />
		<result property="lossDtl"     		column="LOSS_DTL" />
		<result property="currencyCd"     	column="CURRENCY_CD" />
		<result property="totalLossExpRes"  column="T_LOSS_EXP_RES" />
		<result property="totalLossExpPd"   column="T_LOSS_EXP_PD" />
		<result property="processedBy"     	column="PROCESSED_BY" />
		<result property="createUser"     	column="CREATE_USER" />
		<result property="createDate"     	column="CREATE_DATE" typeHandler="ph.cpi.rest.api.typehandler.DateTimeTypeHandler" />
		<result property="updateUser"     	column="UPDATE_USER" />
		<result property="updateDate"     	column="UPDATE_DATE" typeHandler="ph.cpi.rest.api.typehandler.DateTimeTypeHandler" />
		<association property="clmAdjusterList" resultMap="clmAdjusterListAssoc" />
	</resultMap>
	
	<resultMap type="ph.cpi.rest.api.model.claims.ClaimAdjuster" id="clmAdjusterListAssoc">
		<result property="adjName"     		column="ADJ_NAME" />
	</resultMap>
	
	<select id="retrieveClaimListing" resultMap="claimsListingMap" parameterType="java.util.Map">
		SELECT * FROM TABLE(CLM_GEN_INFO_PKG.ret_clm_list(
														#{claimNo,jdbcType=VARCHAR},
														#{cedingName,jdbcType=VARCHAR},
														#{clmStatus,jdbcType=VARCHAR},
														#{policyNo,jdbcType=VARCHAR},
														#{insuredDesc,jdbcType=VARCHAR},
														#{riskName,jdbcType=VARCHAR},
														CAST(to_timestamp(#{lossDateFrom,jdbcType=DATE}, 'YYYY-MM-DD"T"HH24:MI:SS') AS DATE),
														CAST(to_timestamp(#{lossDateTo,jdbcType=DATE}, 'YYYY-MM-DD"T"HH24:MI:SS') AS DATE),
														#{currencyCd,jdbcType=VARCHAR},
														#{processedBy,jdbcType=VARCHAR}, 
														'', '', '','')
						 )
		
	</select>
</mapper>